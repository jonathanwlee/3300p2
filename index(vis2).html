<html>
<head>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<style>
	line {stroke:black}
	text {text-anchor: middle; alignment-baseline:middle; font-family: Arial}
	.axis path {fill: none; stroke:black;}
	.axis line {stroke:black;}
	.axis text {font-size:.75em; fill:black}
	path.plot {fill:none; stroke-width:2}
	h2 {margin-left:125px}
	
	div.container {position: relative; width: 1200px;}
	div.chart {position: absolute; top: 40px; right: 260px;}
	div.in {position: absolute; left:20px;}
	div.label {font-size:16px; font-weight:bold; margin-bottom: 10px; margin-top: 10px}
	div.legend {position:absolute; top: 100px;right:140px;}
	</style>
	
</head>

<body>
<div class="container">
	<div class="in">
	<div class="label">Select Metric to Compare:</div>
	<select id="metricsel">
		<option value="Total Shots">Total Shots</option>
		<option value="Corners">Corners</option>
		<option value="Crosses">Crosses</option>
		<option value="Goals">Goals</option>
		<option value="Penalties">Penalties</option>
	</select>

	<div class="label">Select Teams to Display Data:</div>
	<form>
		<input type="checkbox" id="t1" value="Leicester">Leicester City<br>
		<input type="checkbox" id="t2" value="Spurs">Tottenham Hotspur<br>
		<input type="checkbox" id="t3" value="Man City">Manchester City<br>
		<input type="checkbox" id="t4" value="Arsenal">Arsenal<br>
		<input type="checkbox" id="t5" value="Man Utd">Manchester United<br>
		<input type="checkbox" id="t6" value="West Ham">West Ham United<br>
		<input type="checkbox" id="t7" value="Southampton">Southampton<br>
		<input type="checkbox" id="t8" value="Liverpool">Liverpool<br>
		<input type="checkbox" id="t9" value="Stoke">Stoke City<br>
		<input type="checkbox" id="t10" value="Chelsea">Chelsea<br>
		<input type="checkbox" id="t11" value="Everton">Everton<br>
		<input type="checkbox" id="t12" value="Watford">Watford<br>
		<input type="checkbox" id="t13" value="Bournemouth">Bournemouth<br>
		<input type="checkbox" id="t14" value="West Brom">West Brom<br>
		<input type="checkbox" id="t15" value="Swansea">Swansea City<br>
		<input type="checkbox" id="t16" value="Crystal Palace">Crystal Palace<br>
		<input type="checkbox" id="t17" value="Norwich">Norwich City<br>
		<input type="checkbox" id="t18" value="Sunderland">Sunderland<br>
		<input type="checkbox" id="t19" value="Newcastle">Newcastle United<br>
		<input type="checkbox" id="t20" value="Aston Villa">Aston Villa<br>
	</form>
	</div>
	<div class="chart">
		<svg id="graph" width="700" height="500"></svg>
	</div>
	<div class="legend" id="leg"></div>
</div>
<script>



var data;
d3.csv("gamestats.csv", function (error, rows) {
		if (error) {console.log(error);}
		data = processData(rows);
		genGraph(data);
});

//Compile team stats into an object array
function processData (rows)
{
	var teamdata = [];
	//Parse csv file
	for(var i = 0; i <rows.length; i++)
	{
		var away = rows[i].away_team;
		var home = rows[i].home_team;
		
		//Collect relevant data
		var hs = rows[i].total_shots_home_team, as = rows[i].total_shots_away_team;
		var hcn = rows[i].corners_home_team, acn = rows[i].corners_away_team;
		var hcr = rows[i].crosses_home_team, acr = rows[i].crosses_away_team;
		var hg = rows[i].home_goals, ag = rows[i].away_goals;
		var hp = rows[i].penalties_home_team, ap = rows[i].penalties_away_team;
		
		var a = teamdata.findIndex(function (d){return d.team == away});
		var h = teamdata.findIndex(function (d){return d.team == away});
		//Add home/away team if not encountered yet, then append data
		if (a == -1)
		{
			var stats = {team:away, shots:[as],corner:[acn],cross:[acr],
			goals:[ag],pens:[ap]};
			teamdata.push(stats);
		}
		else
		{
			teamdata[a].shots.push(as);
			teamdata[a].corner.push(acn);
			teamdata[a].cross.push(acr);
			teamdata[a].goals.push(ag);
			teamdata[a].pens.push(ap);	
		}
		
		if (h == -1)
		{
			var stats = {team:home, shots:[hs],corner:[hcn],cross:[hcr],
			goals:[hg],pens:[hp]};
			teamdata.push(stats);
		}
		else
		{
			teamdata[h].shots.push(hs);
			teamdata[h].corner.push(hcn);
			teamdata[h].cross.push(hcr);
			teamdata[h].goals.push(hg);
			teamdata[h].pens.push(hp);	
		}	
	}
	return teamdata;
}

//Generate Graph
function genGraph (teamdata)
{
	var svg = d3.select("#graph");
	var width = svg.attr("width");
	var height = svg.attr("height");
	var padding = 60;
	
	//Clear svg
	svg.selectAll("*").remove();
	
	svg.append("rect").attr("height",height-padding*2).attr("width",width)
	.attr("x",padding).attr("y",padding).style("fill", "black").style("opacity",.1);
	
	//See which teams are selected for comparison
	var teams = [];
	for (var i=0; i < 20; i++)
	{
		if (document.getElementById("t"+(i+1)).checked)
			teams.push(document.getElementById("t"+(i+1)).value);
	}
	
	//Get relevant data for each selected team
	var teamstats = [];
	var max = 0;
	switch (document.getElementById("metricsel").value)
	{
		case "Total Shots":
			for (var i = 0; i <teamdata.length;i++)
			{
				var tmp = Math.max.apply(Math,teamdata[i].shots);
				if (tmp>max)
					max = tmp;
				if (teams.indexOf(teamdata[i].team)!= -1)
					teamstats.push({team:teamdata[i].team,data:teamdata[i].shots});
			}
			break;
		case "Corners":
			for (var i = 0; i <teamdata.length;i++)
			{
				var tmp = Math.max.apply(Math,teamdata[i].corner);
				if (tmp>max)
					max = tmp;
				if (teams.indexOf(teamdata[i].team)!= -1)
					teamstats.push({team:teamdata[i].team,data:teamdata[i].corner});
			}
			break;
		case "Crosses":
			for (var i = 0; i <teamdata.length;i++)
			{
				var tmp = Math.max.apply(Math,teamdata[i].cross);
				if (tmp>max)
					max = tmp;
				if (teams.indexOf(teamdata[i].team)!= -1)
					teamstats.push({team:teamdata[i].team,data:teamdata[i].cross});
			}
			break;
		case "Goals":
			for (var i = 0; i <teamdata.length;i++)
			{
				var tmp = Math.max.apply(Math,teamdata[i].goals);
				if (tmp>max)
					max = tmp;
				if (teams.indexOf(teamdata[i].team)!= -1)
					teamstats.push({team:teamdata[i].team,data:teamdata[i].goals});
			}
			break;
		case "Penalties":
			for (var i = 0; i <teamdata.length;i++)
			{
				var tmp = Math.max.apply(Math,teamdata[i].pens);
				if (tmp>max)
					max = tmp;
				if (teams.indexOf(teamdata[i].team)!= -1)
					teamstats.push({team:teamdata[i].team,data:teamdata[i].pens});
			}
			break;
	}
	//Set Linear Scaling
	var xScale = d3.scale.linear().domain([0, 32])
	.range([padding, width]);
	var yScale = d3.scale.linear().domain([0,max])
	.range([height-padding, padding]);

	//Generate Axes
	var xAxis = d3.svg.axis().scale(xScale).orient("bottom");
	var yAxis = d3.svg.axis().scale(yScale).orient("left").tickFormat(d3.format("d"));
	svg.append("g").attr("class", "axis").attr("transform","translate(0,"+yScale(0)+")")
	.call(xAxis);
	svg.append("g").attr("class", "axis").attr("transform","translate(60,0)")
	.call(yAxis);

				
	//Axis Labels
	svg.append("text").attr("x",padding).attr("y",250)
	.attr("transform", "translate (-240,300) rotate(-90)")
	.style("font-weight","bold").text(d3.select("#metricsel").node().value); ;
	svg.append("text").attr("y",yScale(0)+32).attr("x",width-20)
	.style("font-weight", "bold").text("Week");

	//Plot Points
	for (var t = 0; t < teamstats.length; t++)
	{
		for (var i=0; i < teamstats[t].data.length; i++)
		{
			svg.append("circle").attr("cx", xScale(i))
			.attr("cy", yScale(teamstats[t].data[i]))
			.attr("r", 2).style("fill", "black");
		}
	}

	//Plot Paths
	var week;
	var plotline = d3.svg.line()
	.x(function (d){week++; return xScale(week)})
	.y(function (d) {return yScale(d)});
	
	var color = d3.scale.category20();
	for (var t=0; t < teamstats.length; t++)
	{
		week = -1;
		svg.append("path").attr("d", plotline(teamstats[t].data))
		.attr("class","plot").attr("stroke", color(t));
	}
	
	
	//Generate legend
	d3.select("#leg").select("svg").remove();
	var legend = d3.select("#leg").append("svg").attr("width", 110)
	.attr("height", teams.length*20);
	legend.append("rect").attr("x", 0).attr("y",0)
	.attr("width", 100).attr("height", teams.length*17).style("stroke", "black")
	.style("fill","none");
	var space = 15;
	for (var t=0;t < teams.length; t++)
	{
		legend.append("rect").attr("x", 5).attr("y", t*space + 5)
		.attr("width", 10).attr("height",10).style("fill",color(t));
		
		legend.append("text").attr("x",52).attr("y", t*space+10)
		.style("font-size", 10).text(teams[t]);
	}
	
}

//Update Graph when a new metric/team is selected
d3.selectAll("#metricsel").on("change", function(){genGraph(data)});
d3.selectAll("input").on("change", function(){genGraph(data)});


</script>
</body>
</html>

