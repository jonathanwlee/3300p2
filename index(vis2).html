<head>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<style>
	line {stroke:black}
	text {text-anchor: middle; alignment-baseline:middle; font-family: Arial}
	text.popup {font-size: 10; font-family: Arial}
	.axis path {fill: none; stroke:black;stroke-width:2;}
	.axis line {stroke:black;}
	.axis text {font-size:.75em; fill:black}
	path.plot {fill:none; stroke-width:2}
	h2 {margin-left:125px}
	rect.popup {width: 170; height: 50; rx: 6; ry: 6; fill: DarkSalmon}
	
	div.container {position: relative; width: 1700px;}
	div.chart {position: absolute; top: 40px; left: 0px;}
	div.in {position: absolute; right: 100px;}
	div.label {font-size:16px; font-weight:bold; margin-bottom: 10px;
	margin-top: 10px; font-family: Arial}
	div.legend {position:absolute; top: 100px;right:380px;}
	</style>
	
</head>

<body>
<div class="container">
	<div class="in">
	<input type="checkbox" id="toggle">Check to See Cumulative Season Data<br>
	<div class="label">Select Metric to Compare:</div>
	<select id="metricsel">
		<option value="Total Shots">Total Shots</option>
		<option value="Corners">Corners</option>
		<option value="Crosses">Crosses</option>
		<option value="Goals">Goals</option>
		<option value="Penalties">Penalties</option>
		<option value="Saves">Saves</option>
		<option value="Goals Conceded">Goals Conceded</option>
	</select>

	<div class="label">Select Teams to Display Data:</div>
	<form>
		<input type="checkbox" id="t1" value="Leicester" checked>Leicester City<br>
		<input type="checkbox" id="t2" value="Spurs" checked>Tottenham Hotspur<br>
		<input type="checkbox" id="t3" value="Man City" checked>Manchester City<br>
		<input type="checkbox" id="t4" value="Arsenal" checked>Arsenal<br>
		<input type="checkbox" id="t5" value="Man Utd">Manchester United<br>
		<input type="checkbox" id="t6" value="West Ham">West Ham United<br>
		<input type="checkbox" id="t7" value="Southampton">Southampton<br>
		<input type="checkbox" id="t8" value="Liverpool">Liverpool<br>
		<input type="checkbox" id="t9" value="Stoke">Stoke City<br>
		<input type="checkbox" id="t10" value="Chelsea">Chelsea<br>
		<input type="checkbox" id="t11" value="Everton">Everton<br>
		<input type="checkbox" id="t12" value="Watford">Watford<br>
		<input type="checkbox" id="t13" value="Bournemouth">Bournemouth<br>
		<input type="checkbox" id="t14" value="West Brom">West Brom<br>
		<input type="checkbox" id="t15" value="Swansea">Swansea City<br>
		<input type="checkbox" id="t16" value="Crystal Palace">Crystal Palace<br>
		<input type="checkbox" id="t17" value="Norwich">Norwich City<br>
		<input type="checkbox" id="t18" value="Sunderland">Sunderland<br>
		<input type="checkbox" id="t19" value="Newcastle">Newcastle United<br>
		<input type="checkbox" id="t20" value="Aston Villa">Aston Villa<br>
	</form>
	</div>
	<div class="chart">
		<svg id="graph" width="1200" height="500"></svg>
	</div>
	<div class="legend" id="leg"></div>
</div>
<script>

var data,test;
d3.csv("gamestats.csv", function (error, rows) {
		if (error) {console.log(error);}
		data = processData(rows);
		genGraph(data);
});

//Compile team stats into an object array
function processData (rows)
{
	var teamdata = [];
	//Parse csv file
	for(var i = 0; i <rows.length; i++)
	{
		var away = rows[i].away_team;
		var home = rows[i].home_team;
		
		//Collect relevant data
		var hs = parseInt(rows[i].total_shots_home_team), as = parseInt(rows[i].total_shots_away_team);
		var hcn = parseInt(rows[i].corners_home_team), acn = parseInt(rows[i].corners_away_team);
		var hcr = parseInt(rows[i].crosses_home_team), acr = parseInt(rows[i].crosses_away_team);
		var hg = parseInt(rows[i].home_goals), ag = parseInt(rows[i].away_goals);
		var hp = parseInt(rows[i].penalties_home_team), ap = parseInt(rows[i].penalties_away_team);
		var hsv = parseInt(rows[i].saves_home_team), asv = parseInt(rows[i].saves_away_team);
		
		//Get game details
		var date = rows[i].date;
		var venue = rows[i].venue;
		
		var a = teamdata.findIndex(function (d){return d.team == away});
		var h = teamdata.findIndex(function (d){return d.team == home});
		//Add home/away team if not encountered yet, then append data
		if (a == -1)
		{
			var stats = {team:away, shots:[as],corner:[acn],cross:[acr],
			goals:[ag],pens:[ap],saves:[asv], home:[home], away:[away],date:[date],
			venue:[venue], goalc:[hg]};
			teamdata.push(stats);
		}
		else
		{
			teamdata[a].shots.push(as);
			teamdata[a].corner.push(acn);
			teamdata[a].cross.push(acr);
			teamdata[a].goals.push(ag);
			teamdata[a].pens.push(ap);	
			teamdata[a].saves.push(asv);
			teamdata[a].home.push(home);
			teamdata[a].away.push(away);
			teamdata[a].date.push(date);
			teamdata[a].venue.push(venue);
			teamdata[a].goalc.push(hg);
		}
		
		if (h == -1)
		{
			var stats = {team:home, shots:[hs],corner:[hcn],cross:[hcr],
			goals:[hg],pens:[hp],saves:[hsv], home:[home], away:[away], date:[date],
			venue:[venue], goalc:[ag]};
			teamdata.push(stats);
		}
		else
		{
			teamdata[h].shots.push(hs);
			teamdata[h].corner.push(hcn);
			teamdata[h].cross.push(hcr);
			teamdata[h].goals.push(hg);
			teamdata[h].pens.push(hp);
			teamdata[h].saves.push(hsv);
			teamdata[h].home.push(home);
			teamdata[h].away.push(away);
			teamdata[h].date.push(date);
			teamdata[h].venue.push(venue);		
			teamdata[h].goalc.push(ag);
		}	
	}
	return teamdata;
}

//Generate Graph
function genGraph (teamdata)
{
	var svg = d3.select("#graph");
	var width = svg.attr("width");
	var height = svg.attr("height");
	var padding = 60;
	
	//Clear svg
	svg.selectAll("*").remove();
	
	svg.append("rect").attr("height",height-padding*2).attr("width",width)
	.attr("x",padding).attr("y",padding).style("fill", "black").style("opacity",.1);
	
	//See which teams are selected for comparison
	var teams = [];
	for (var i=0; i < 20; i++)
	{
		if (document.getElementById("t"+(i+1)).checked)
			teams.push(document.getElementById("t"+(i+1)).value);
	}
	
	//Get relevant data for each selected team
	var teamstats = [];
	var max = 0;
	switch (document.getElementById("metricsel").value)
	{
		case "Total Shots":
			//Iterate through team data and collect data for teamstats
			//that are selected
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].shots.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].shots.slice()
					,games:gamedets});
				}
					
			}
			break;
		case "Corners":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].corner.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].corner.slice()
					,games:gamedets});
				}
			}
			break;
		case "Crosses":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].cross.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].cross.slice()
					,games:gamedets});
				}
			}
			break;
		case "Goals":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].goals.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].goals.slice()
					,games:gamedets});
				}
			}
			break;
		case "Penalties":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].pens.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].pens.slice()
					,games:gamedets});
				}
			}
			break;
		case "Saves":
			for (var i = 0; i <teamdata.length;i++)
				{
					if (teams.indexOf(teamdata[i].team)!= -1)
					{
						var gamedets = [];
						for (var t=0;t<teamdata[i].saves.length;t++)
						{
							gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
						}
						teamstats.push({team:teamdata[i].team,data:teamdata[i].saves.slice()
						,games:gamedets});
					}
				}
				break;
		case "Goals Conceded":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].goalc.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].goalc.slice()
					,games:gamedets});
				}
			}
			break;
	}
	test = teamstats;
	//Check to See if Data should be displayed cumulatively or not
	if (document.getElementById("toggle").checked)
	{
		teamstats.forEach(function (d){
			for (var i=1;i<d.data.length;i++)
			{
				d.data[i] += d.data[i-1];
			}
		})
	}
	test = teamstats;
	
	//Find data maximum for scaling
	var max = 0;
	teamstats.forEach(function (d){
	var tmp = Math.max.apply(Math,d.data);
	if (tmp>max) max=tmp;});
	
	//Set Linear Scaling
	var xScale = d3.scale.linear().domain([0, 32])
	.range([padding, width]);
	var yScale = d3.scale.linear().domain([0,max])
	.range([height-padding, padding]);

	//Generate Axes
	var xAxis = d3.svg.axis().scale(xScale).orient("bottom");
	var yAxis = d3.svg.axis().scale(yScale).orient("left").tickFormat(d3.format("d"));
	svg.append("g").attr("class", "axis").attr("transform","translate(0,"+yScale(0)+")")
	.call(xAxis);
	svg.append("g").attr("class", "axis").attr("transform","translate(60,0)")
	.call(yAxis);

				
	//Axis Labels and Chart Title
	if (document.getElementById("toggle").checked)
	{	svg.append("text").attr("x",width/2 + 30).attr("y",20)
		.style("font-weight","bold").style("font-size",20)
		.text("Cumulative " + d3.select("#metricsel").node().value + " over the Season");
	
		svg.append("text").attr("x",width/2 + 30).attr("y",40)
		.style("font-weight","bold").style("font-size",14)
		.text("(Hover over points to see game details)");
	}
	else
	{	svg.append("text").attr("x",width/2 + 30).attr("y",20)
		.style("font-weight","bold").style("font-size",20)
		.text(d3.select("#metricsel").node().value + " per Game");
		
		svg.append("text").attr("x",width/2 + 30).attr("y",40)
		.style("font-weight","bold").style("font-size",14)
		.text("(Hover over points to see game details)");
	}
	svg.append("text").attr("x",padding).attr("y",250)
	.attr("transform", "translate (-240,300) rotate(-90)")
	.style("font-weight","bold").text(d3.select("#metricsel").node().value); ;
	svg.append("text").attr("y",yScale(0)+32).attr("x",width-20)
	.style("font-weight", "bold").text("Week");

	//Plot Points
	var color = d3.scale.category20();
	for (var t = 0; t < teamstats.length; t++)
	{
		for (var i=0; i < teamstats[t].data.length; i++)
		{
			svg.append("circle").attr("id",teamstats[t].team)
			.attr("cx", xScale(i)).attr("cy", yScale(teamstats[t].data[i]))
			.attr("r", 6).style("fill", color(t));
		}
		
		//Display game details when hovering
			var sel = svg.selectAll("circle[id='"+teamstats[t].team+"']");
			sel.data(teamstats[t].games).enter();
			sel.on("mouseover",function(){
				var curr = d3.select(this);
				var circposx = parseInt(curr.attr("cx")),circposy=parseInt(curr.attr("cy"));
				curr.style("stroke","black").attr("stroke-width",2);
				
				if (circposx >= xScale(29))
					circposx -= 70;
				else if (circposx == xScale(0))
					circposx += 20;
				svg.append("rect").attr("class","popup").attr("x",circposx-70)
				.attr("y",circposy-60);
			
				var inf = curr.data(); 
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-50).text("Home Team: " + inf[0].home);
				
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-40).text("Away Team: " + inf[0].away);
				
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-30).text("Date: " + inf[0].dat);
				
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-20).text("Venue: " + inf[0].ven);
				
			})
			.on("mouseout",function(){d3.select(this).style("stroke","none");
			d3.selectAll("rect.popup").remove();
			d3.selectAll("text.popup").remove();});
		
	}


	//Plot Paths
	var week;
	var plotline = d3.svg.line()
	.x(function (d){week++; return xScale(week)})
	.y(function (d) {return yScale(d)});
	
	for (var t=0; t < teamstats.length; t++)
	{
		week = -1;
		svg.append("path").attr("d", plotline(teamstats[t].data))
		.attr("class","plot").attr("stroke", color(t));
	}
	
	
	//Generate legend
	d3.select("#leg").select("svg").remove();
	var legend = d3.select("#leg").append("svg").attr("width", 110)
	.attr("height", teams.length*20);
	legend.append("rect").attr("x", 0).attr("y",0)
	.attr("width", 100).attr("height", teams.length*17).style("stroke", "black")
	.style("fill","none");
	var space = 15;
	for (var t=0;t < teamstats.length; t++)
	{
		legend.append("rect").attr("x", 5).attr("y", t*space + 5)
		.attr("width", 10).attr("height",10).style("fill",color(t));
		
		legend.append("text").attr("x",52).attr("y", t*space+10)
		.style("font-size", 10).text(teamstats[t].team);
	}
	
}

//Update Graph when a new metric/team is selected
d3.selectAll("#metricsel").on("change", function(){genGraph(data)});
d3.selectAll("input").on("change", function(){genGraph(data)});

</script>
</body>
</html>

