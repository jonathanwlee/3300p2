<html>
<head>
<title>Assignment 6 - Jonathan Lee - jwl274 </title>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<link href="https://fonts.googleapis.com/css?family=Lato&amp;subset=latin,latin-ext" rel="stylesheet" type="text/css">

<style>
	body {font-family:"Lato";}
	.circles_text_table { font-size: 10px; fill:white; text-anchor:middle; alignment-baseline:auto;}

	.points_bar_table { fill:#e0e0e0;}
	.points_text_table {font-size:10px; text-anchor:middle;}
	.club_text_table {font-size:10px; text-anchor:start;}
	.bar_table {fill:none;}

	.win{fill:green;}
	.draw{fill:#e0e0e0;}
	.loss{fill:red;}

	.win_text{font-size:9px;fill:white;}
	.draw_text{font-size:9px;fill:black}
	.loss_text{font-size:9px;fill:white;}

	.season { cursor:pointer;}
	.arrow_table_up {fill:green;}
	.arrow_table_down {fill:red;}
	.arrow_table_netural {fill:lightGray;}	

	.season {
		height:30px;
		display: inline-block;
		padding:0;
		margin:0;	
	}

	.point_line { 
		stroke:rgb(255,0,0);
		stroke-width:2;
	}	

	#slider label {
		position: absolute;
		width: 40px;
		font-size:10px;
		margin-left: -15px;
		text-align: center;
		margin-top: 20px;
	}

	/* below is not necessary, just for style */
	#slider {
		width: 70%;
		margin: 2em auto;
	}

	#seasonYears { 
		width: 70%;
		margin:0 auto;
		padding:0;
	}

	/* Vis2*/
	line {stroke:black}
	text {text-anchor: middle; alignment-baseline:middle; font-family: Arial}
	text.popup {font-size: 10; font-family: Arial}
	.axis path {fill: none; stroke:black;stroke-width:2;}
	.axis line {stroke:black;}
	.axis text {font-size:.75em; fill:black}
	path.plot {fill:none; stroke-width:2}
	h2 {margin-left:125px}
	rect.popup {width: 170; height: 50; rx: 6; ry: 6; fill: DarkSalmon}
	
	div.container {position: relative; width: 1700px;}
	div.chart {position: absolute; top: 40px; left: 0px;}
	div.in {position: absolute; right: 100px;}
	div.label {font-size:16px; font-weight:bold; margin-bottom: 10px;
	margin-top: 10px; font-family: Arial}
	div.legend {position:absolute; top: 100px;right:380px;}

</style>
</head>

<body>
<h1>The Premier League at a Glance</h1>
<p>Leicester City are on track ...</p>
<div id="slider"></div>
	
<script>
	var startPos = 5; 
	$( "#slider" ).slider({
		value: 10,
		min: 1,
		max: 10,
		step: 1
	})
	.each(function() {

	var vals = 9;

	// Space out values
	for (var i = 0; i <= vals; i++) {
		var label;
		if (i==9) { label = "'15-'16";}
		else if(i==8) { label ="'14-'15";}
		else if(i==7) { label ="'13-'14";}
		else if(i==6) { label ="'12-'13";}
		else if(i==5) { label ="'11-'12";}
		else if(i==4) { label ="'10-'11";}
		else if(i==3) { label ="'09-'10";}
		else if(i==2) { label ="'08-'09";}
		else if(i==1) { label ="'07-'08";}
		else if(i==0) { label ="'06-'07";}

		var el = $('<label>' + label + '</label>').css('left',(i/vals*100)+'%');
		$( "#slider" ).append(el);
	 }
	});

  $("#slider").on("slidestop", function(event, ui) {
    endPos = ui.value;
    console.log(endPos);
    if (startPos != endPos) {

	if (endPos ==10 ) {last_season = season_14_15; update_season(season_15_16);}
	else if (endPos == 9) { last_season = season_13_14; update_season(season_14_15);}
	else if (endPos ==8 ) {last_season = season_12_13; update_season(season_13_14);}
	else if (endPos ==7 ) {last_season = season_11_12; update_season(season_12_13);}
	else if (endPos ==6 ) {last_season = season_10_11; update_season(season_11_12);}
	else if (endPos ==5 ) {last_season = season_09_10; update_season(season_10_11);}
	else if (endPos ==4 ) {last_season = season_08_09; update_season(season_09_10);}
	else if (endPos ==3 ) {last_season = season_07_08; update_season(season_08_09);}
	else if (endPos ==2 ) {last_season = season_06_07; update_season(season_07_08);}
	else if (endPos ==1 ) {last_season = season_05_06; update_season(season_06_07);}

    }

    startPos = endPos;
});

</script>

<div id="table"></div>

<script>
var height_table = 600;
var width_table = 1100;
var padding_table = 30;

var svg_table = d3.select("#table").append("svg").attr("height", height_table).attr("width", width_table);
var table; 
var circles_table,circles_text_table;
var club_images_table, club_text_table;
var points_bar_table,points_text_table,bar_table;
var win_bar_table,draw_bar_table,loss_bar_table;
var xScale_table = d3.scale.linear().domain([0,102]).range([padding_table+190,width_table]);
var season_05_06,season_06_07,season_07_08,season_08_09,season_09_10,season_10_11,season_12_13,season_11_12,season_13_14,season_14_15,season_15_16;
var current_season = "season_15_16";
var points_bars; 
var yScale_table;
var last_season; 
var arrow_table; 
var clicked_array = [];

//Alignment and Sizing Variables
var table_bar_height = 18;
var table_bar_adjustment = 10;


//Initialize 05 - 16 season data in season variables; 
d3.json("epl-05-06.json", function (error, data) {season_05_06 = data; });
d3.json("epl-06-07.json", function (error, data) {season_06_07 = data; });
d3.json("epl-07-08.json", function (error, data) {season_07_08 = data; });
d3.json("epl-08-09.json", function (error, data) {season_08_09 = data; });
d3.json("epl-09-10.json", function (error, data) {season_09_10 = data; });
d3.json("epl-10-11.json", function (error, data) {season_10_11 = data; });
d3.json("epl-11-12.json", function (error, data) {season_11_12 = data; });
d3.json("epl-12-13.json", function (error, data) {season_12_13 = data; });
d3.json("epl-13-14.json", function (error, data) {season_13_14 = data; });
d3.json("epl-14-15.json", function (error, data) {season_14_15 = data; });

d3.json("epl-15-16.json", function (error, data) {
//Initialize array for monitoring click events
for (p=0;p<20;p++) { 
	clicked_array[p] = 0;
}

//Initialize last season to 14_15; 
last_season = season_14_15;
season_15_16 = data; 

//Scales for positions 1-20. 
yScale_table = d3.scale.ordinal().domain([1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]).rangeBands([padding_table,height_table-padding_table]);

//Add Circles and Rank Labeling
circles_table = svg_table.selectAll(".circles_table").data(season_15_16);
circles_table.enter().append("circle")
	.attr("class","circles_table")
	.attr("r",10)
	.attr("fill","#2166ac")
	.attr("cx",padding_table)
	.attr("cy",function(d) {
		return yScale_table(d.rank);
	})

circles_text_table = svg_table.selectAll(".circles_text_table").data(season_15_16);
circles_text_table.enter().append("text")
	.attr("class","circles_text_table")
	.attr("text-anchor","middle")
	.attr("dx",padding_table)
	.attr("y",function(d) { 	
		return yScale_table(d.rank);
	})
	.attr("dy",".35em")
	.text(function(d) {return d.rank;});

//Add Club Images and Text
club_images_table = svg_table.selectAll(".club_images_table").data(season_15_16);
club_images_table.enter().append("svg:image")
	.attr("class","club_images_table")
	.attr("xlink:href", function(d) {
		var club_name = d.team.replace(/\s/g, '');
		return "images/"  + club_name + ".png"; })
	.attr("x",padding_table+145)
	.attr("y",function(d) { return yScale_table(d.rank) - table_bar_adjustment;})
	.attr("width",20)
	.attr("height",20);

club_text_table = svg_table.selectAll(".club_text_table").data(season_15_16);
club_text_table.enter().append("text")
	.attr("class","club_text_table")
	.attr("x",padding_table+20)
	.attr("dy",".35em")
	.attr("y",function(d) { 	
		return yScale_table(d.rank);
	})
	.text(function(d) {return d.team;});

//Add Win, Draw, and Loss Bar
win_bar_table = svg_table.selectAll(".win_bar_table").data(season_15_16);
win_bar_table.enter().append("rect")
	.attr("class",function(d,i) {return "wins_" + i + " win";})
	.attr("pointer-events","none")
	.attr("x",xScale_table(0))
	.attr("y",function(d) {return yScale_table(d.rank)-table_bar_adjustment;})
	.attr("width", function(d) { 
		return 0;
	})
	.attr("height",table_bar_height);

draw_bar_table = svg_table.selectAll(".draw_bar_table").data(season_15_16);
draw_bar_table.enter().append("rect")
	.attr("class",function(d,i) {return "draws_" + i  + " draw";})
	.attr("pointer-events","none")
	.attr("x",function(d) { return xScale_table(d.wins*3);})
	.attr("y",function(d) {return yScale_table(d.rank)-table_bar_adjustment;})
	.attr("width", function(d) { 
		return 0;
	})
	.attr("height",table_bar_height);

loss_bar_table = svg_table.selectAll(".loss_bar_table").data(season_15_16);
loss_bar_table.enter().append("rect")
	.attr("class",function(d,i) {return "losses_" + i + " loss";})
	.attr("pointer-events","none")
	.attr("x",function(d) { return xScale_table(d.wins*3 + d.draws) })
	.attr("y",function(d) {return yScale_table(d.rank)-table_bar_adjustment;})
	.attr("width", function(d) { return 0;})
	.attr("height",table_bar_height);

//Add points at the end of points bar
points_text_table = svg_table.selectAll(".points_text_table").data(season_15_16);
points_text_table.enter().append("text")
	.attr("class",function(d,i) {return "points_text_table_" + i + " points_text_table";})
	.attr("x",function(d) { return xScale_table(d.wins*3 + d.draws) + 10;})
	.attr("y",function(d) { 	
		return yScale_table(d.rank);
	})
	.attr("dy",".3em")
	.text(function(d) { return d.points;});

//Add Invisible Bar for Handling Touch Events
bar_table = svg_table.selectAll(".bar_table").data(season_15_16);
bar_table.enter().append("rect")
	.attr("pointer-events","all")
	.attr("class",function(d,i) { return "bar_table_" + i + " bar_table";})
	.attr("width",function(d) { 	
		return xScale_table(d.points) - xScale_table(0);
	})
	.attr("height",table_bar_height)
	.attr("x",xScale_table(0))
	.attr("y",function(d) { 	
		return yScale_table(d.rank)-table_bar_adjustment;
	})
	//Sets on click. Removes or holds win,draw,loss breakdown. 
	.on("click", function(d,i) { 
		if (clicked_array[i] == 0) { 
			d3.select(".points_" + i ).transition().attr("width",function() {return 0;});
			d3.select(".wins_" + i  ).transition().delay(400).attr("width",function() {return xScale_table(d.wins*3) - xScale_table(0);});
			d3.select(".draws_" + i ).transition().delay(450).attr("width",function() {return xScale_table(d.draws) - xScale_table(0);});
			d3.select(".losses_" + i).transition().delay(500).attr("width",function() {return xScale_table(d.losses*3) - xScale_table(0);});
			d3.select(".wins_text_" + i).transition().delay(600).attr("visibility","visible");
			d3.select(".draws_text_" + i ).transition().delay(600).attr("visibility","visible");			
			d3.select(".losses_text_" + i ).transition().delay(600).attr("visibility","visible");
			d3.select(".arrow_table_" + i ).transition().delay(600).attr("visibility","visible");
			d3.selectAll(".points_text_table_" + i ).transition().attr("visibility","hidden");
			clicked_array[i] =1;

			d3.select(".bar_table_" + i).attr("width",function() { return xScale_table(d.points)-xScale_table(0) + xScale_table(d.losses*3) - xScale_table(0); });
		}
		else { 
			d3.select(".wins_" + i).transition().attr("width",function() {return 0;});
			d3.select(".draws_" + i ).transition().attr("width",function() {return 0;});
			d3.select(".losses_" + i ).transition().attr("width",function() {return 0;});
			d3.select(".points_" + i ).transition().delay(500).attr("width",xScale_table(d.points) - xScale_table(0));
			d3.select(".wins_text_" + i ).transition().delay(250).attr("visibility","hidden");
			d3.select(".draws_text_" + i ).transition().delay(250).attr("visibility","hidden");			
			d3.select(".losses_text_" + i ).transition().delay(250).attr("visibility","hidden");	
			d3.select(".arrow_table_" + i ).transition().delay(250).attr("visibility","hidden");					
			d3.selectAll(".points_text_table_" + i ).transition().delay(600).attr("visibility","visible");	
			clicked_array[i] = 0;		
			
			d3.select(".bar_table_" + i).attr("width",function() {return xScale_table(d.points)-xScale_table(0);} );
		}
		
	})
	//Set mouse enter. 
	//Removes points bar and transitions to win,draw,loss breakdown. 
	.on("mouseenter",function(d,i) { 
	if (clicked_array[i] ==0) { 
		d3.select(".points_" + i ).transition().attr("width",function() {return 0;});
		d3.select(".wins_" + i  ).transition().duration(250).delay(250).attr("width",function() {return xScale_table(d.wins*3) - xScale_table(0);});
		d3.select(".draws_" + i ).transition().duration(250).delay(300).attr("width",function() {return xScale_table(d.draws) - xScale_table(0);});
		d3.select(".losses_" + i).transition().duration(250).delay(350).attr("width",function() {return xScale_table(d.losses*3) - xScale_table(0);});
		d3.select(".wins_text_" + i).transition().delay(600).attr("visibility","visible");
		d3.select(".draws_text_" + i ).transition().delay(600).attr("visibility","visible");			
		d3.select(".losses_text_" + i ).transition().delay(600).attr("visibility","visible");
		d3.select(".arrow_table_" + i ).transition().delay(600).attr("visibility","visible");
		d3.selectAll(".points_text_table_" + i ).transition().attr("visibility","hidden");

		d3.select(".bar_table_" + i).attr("width",function() { return xScale_table(d.points)-xScale_table(0) + xScale_table(d.losses*3) - xScale_table(0); });
	}
	})
	//Set Mouseleave
	//Removes win,draw,loss breakdown and transitions to point overview.
	.on("mouseleave",function(d,i) { 
	if (clicked_array[i] ==0) { 
		d3.select(".wins_" + i).transition().duration(350).delay(100).attr("width",function() {return 0;});
		d3.select(".wins_text_" + i ).transition().delay(350).attr("visibility","hidden");

		d3.select(".draws_" + i ).transition().duration(250).delay(100).attr("width",function() {return 0;});
		d3.select(".draws_text_" + i ).transition().delay(300).attr("visibility","hidden");			

		d3.select(".losses_" + i ).transition().duration(250).delay(0).attr("width",function() {return 0;});
		d3.select(".losses_text_" + i ).transition().delay(250).attr("visibility","hidden");	

		d3.select(".points_" + i ).transition().duration(250).delay(400).attr("width",xScale_table(d.points) - xScale_table(0));
		d3.selectAll(".points_text_table_" + i ).transition().delay(600).attr("visibility","visible");		

		d3.select(".arrow_table_" + i ).transition().delay(250).attr("visibility","hidden");	
		d3.select(".bar_table_" + i).attr("width",function() {return xScale_table(d.points)-xScale_table(0);} );
	}	
	});

points_bar_table = svg_table.selectAll(".points_bar_table").data(season_15_16);
points_bar_table.enter().append("rect")
	.attr("pointer-events","none")
	.attr("class",function(d,i) {return "points_" + i + " points_bar_table";})
	.attr("width",function(d) { 	
	return xScale_table(d.points)-xScale_table(0);
	})
	.attr("height",table_bar_height)
	.attr("x",function(d) {return xScale_table(0);})
	.attr("y",function(d) { 	
	return yScale_table(d.rank)-table_bar_adjustment;
	});

//Adds Win, Draw, and Loss text
win_text_table = svg_table.selectAll("win_text_table").data(season_15_16);
win_text_table.enter().append("text")
	.attr("class",function(d,i) {return "wins_text_" + i + " win_text";})
	.attr("pointer-events","none")
	.attr("x",function(d) { return xScale_table(0) + 3})
	.attr("y",function(d) {return yScale_table(d.rank);})
	.attr("dy",".30em")
	.attr("visibility","hidden")
	.text(function(d) {
	return d.wins + " wins"; 
	});	

draw_text_table = svg_table.selectAll("draw_text_table").data(season_15_16);
draw_text_table.enter().append("text")
	.attr("class",function(d,i) {return "draws_text_" + i + " draw_text";})
	.attr("pointer-events","none")
	.attr("x",function(d) { return xScale_table(d.wins*3) + 3;})
	.attr("y",function(d) {return yScale_table(d.rank);})
	.attr("dy",".30em")
	.attr("visibility","hidden")
	.text(function(d) {
	return d.draws + " draws"; 
	});	

loss_text_table = svg_table.selectAll("loss_text_table").data(season_15_16);
loss_text_table.enter().append("text")
	.attr("class",function(d,i) {return "losses_text_" + i + " loss_text";})
	.attr("pointer-events","none")
	.attr("x",function(d) { return xScale_table(d.wins*3 + d.draws) + 3})
	.attr("y",function(d) {return yScale_table(d.rank);})
	.attr("visibility","hidden")
	.attr("dy",".30em")
	.text(function(d) {
	return d.losses + " losses"; 
	});	

//Adds arrows up / down / no movement based off previous seasons position. 
arrow_table = svg_table.selectAll(".arrow_table_up.arrow_table_down.arrow_table_neutral").data(season_15_16);
arrow_table.enter().append("text")
	.attr("class",function(d,i) {
	var result = lastSeason(d,i);
	if (result[1] == 0) { 
		return "arrow_table_up" + " arrow_table_" +i + " arrow";
	}
	else if (result[1] ==1) { 
		return "arrow_table_down" + " arrow_table_" +i + " arrow";
	}
	else { 
		return "arrow_table_neutral" + " arrow_table_" + i + " arrow";
	}})
	.attr("x",function(d) { return xScale_table(d.wins*3 + d.draws + d.losses*3) + 10;})
	.attr("y",function(d) { 	
	return yScale_table(d.rank);
	})
	.attr("dy",".15em")
	.attr("visibility","hidden")
	.text(function(d,i) { 
			var result = lastSeason(d,i);
			return result[0];
		});
	});

/*
Finds the difference between current season and last season. 
Returns String to use in arrow_text. 
*/
function lastSeason (d,i) { 
	var current_rank = d.rank;
	var difference;
	//Find difference between current position and last season's position. 
	for( c =0; c < last_season.length; c++) { 
		if (last_season[c].team == d.team) { 
			difference = last_season[c].rank - d.rank;
		}
	}
	if (difference >0) { 
		return [String.fromCharCode(8593) + " +" + difference,0];

	}
	else if (difference <0) { 
		return [String.fromCharCode(8595) + " " + difference,1];
	}

	else if (difference ==0) { 
		return  [String.fromCharCode(8593) + String.fromCharCode(8595)+ " " + difference,2];

	}
	//If not found, team must have been promoted this season. Returns promoted text. 
	else { 
		return [String.fromCharCode(8593) + " promoted",0];
	}
}

/*
Updates season data based off selected season on slider. Makes appropriate changes to all elements. 
*/
function update_season(season) {
	//Current season is not finished. Scale is based off max number of points capable of reaching. 
	if (season == season_15_16) { 
		xScale_table = d3.scale.linear().domain([0,102]).range([padding_table+190,width_table]);
	}
	else { 
		xScale_table = d3.scale.linear().domain([0,114]).range([padding_table+190,width_table]);
	}

	//Reset Clicked Array for use in click events
	for (p=0;p<20;p++) { 
		clicked_array[p] = 0;
	}

	//Update arrow text. 
	svg_table.selectAll(".arrow").data(season)
		.attr("class",function(d,i) {
			var result = lastSeason(d,i);
			if (result[1] == 0) { 
				return "arrow_table_up" + " arrow_table_" +i +" arrow";
			}

			else if (result[1] ==1) { 
				return "arrow_table_down" + " arrow_table_" +i + " arrow";
			}

			else { 
				return "arrow_table_neutral" + " arrow_table_" + i + " arrow";
			}

		})
		.attr("x",function(d) { return xScale_table(d.wins*3 + d.draws + d.losses*3) + 10;})
		.attr("y",function(d) { 	
			return yScale_table(d.rank);
		})
		.attr("dy",".30em")
		.attr("visibility","hidden")
		.text(function(d,i) { 
			//console.log(d.team + "  i");
			var result = lastSeason(d,i);
			return result[0];
		});
	//Add Points, Club Text, Club Images
	svg_table.selectAll(".points_text_table").data(season)
		.attr("class",function(d,i) {return "points_text_table_" + i + " points_text_table";})
		.attr("x",function(d) { return xScale_table(d.wins*3 + d.draws) + 10;})
		.attr("y",function(d) { 	
			return yScale_table(d.rank);
		})
		.attr("dy",".3em")
		.attr("visibility","visible")
		.text(function(d) { return d.points;});

	svg_table.selectAll(".club_images_table").data(season)
		.attr("class","club_images_table")
		.attr("xlink:href", function(d) {
			var club_name = d.team.replace(/\s/g, '');
			return "images/"  + club_name + ".png"; })
		.attr("x",padding_table+145)
		.attr("y",function(d) { return yScale_table(d.rank)-table_bar_adjustment;})
		.attr("width",20)
		.attr("height",20);

	svg_table.selectAll(".club_text_table").data(season)
		.attr("class","club_text_table")
		.attr("x",padding_table+20)
		.attr("dy",".35em")
		.attr("y",function(d) { 	
			return yScale_table(d.rank);
		})
		.text(function(d) {return d.team;});

	//Add Points, Win, Draw, and Loss Bar
	svg_table.selectAll(".points_bar_table").data(season)
		.transition()
		.attr("pointer-events","none")
		.attr("class",function(d,i) {return "points_" + i + " points_bar_table";})
		.attr("width",function(d) { 	
			return xScale_table(d.points) - xScale_table(0);
		})
		.attr("height",table_bar_height)
		.attr("x",xScale_table(0))
		.attr("y",function(d) { 	
			return yScale_table(d.rank)-table_bar_adjustment;
		});

	svg_table.selectAll(".win").data(season)
		.attr("class",function(d,i) {return "wins_" + i + " win";})
		.attr("pointer-events","none")
		.attr("x",padding_table + 190 )
		.attr("y",function(d) {return yScale_table(d.rank)-table_bar_adjustment;})
		.attr("width", function(d) { 
			return 0;
		})
		.attr("height",table_bar_height);

	svg_table.selectAll(".draw").data(season)
		.attr("class",function(d,i) {return "draws_" + i  + " draw";})
		.attr("pointer-events","none")
		.attr("x",function(d) { return xScale_table(d.wins*3);})
		.attr("y",function(d) {return yScale_table(d.rank)-table_bar_adjustment;})
		.attr("width", function(d) { 
			return 0;
		})
		.attr("height",table_bar_height);

	svg_table.selectAll(".loss").data(season)
		.attr("class",function(d,i) {return "losses_" + i + " loss";})
		.attr("pointer-events","none")
		.attr("x",function(d) { return xScale_table(d.wins*3 + d.draws)})
		.attr("y",function(d) {return yScale_table(d.rank)-table_bar_adjustment;})
		.attr("width", function(d) { 
			return 0;
		})
		.attr("height",table_bar_height);

	//Add invisible bar to handle click events 
	svg_table.selectAll(".bar_table").data(season)
		.attr("pointer-events","all")
		.attr("class",function(d,i) { return "bar_table_" + i + " bar_table";})
		.attr("width",function(d) { 	
			return xScale_table(d.points) - xScale_table(0);
		})
		.attr("height",table_bar_height)
		.attr("x",xScale_table(0))
		.attr("y",function(d) { 	
			return yScale_table(d.rank)-table_bar_adjustment;
		})
	//Sets on click. Removes or holds win,draw,loss breakdown. 
	.on("click", function(d,i) { 
		if (clicked_array[i] == 0) { 
			d3.select(".points_" + i ).transition().attr("width",function() {return 0;});
			d3.select(".wins_" + i  ).transition().delay(400).attr("width",function() {return xScale_table(d.wins*3) - xScale_table(0);});
			d3.select(".draws_" + i ).transition().delay(450).attr("width",function() {return xScale_table(d.draws) - xScale_table(0);});
			d3.select(".losses_" + i).transition().delay(500).attr("width",function() {return xScale_table(d.losses*3) - xScale_table(0);});
			d3.select(".wins_text_" + i).transition().delay(600).attr("visibility","visible");
			d3.select(".draws_text_" + i ).transition().delay(600).attr("visibility","visible");			
			d3.select(".losses_text_" + i ).transition().delay(600).attr("visibility","visible");
			d3.select(".arrow_table_" + i ).transition().delay(600).attr("visibility","visible");
			d3.selectAll(".points_text_table_" + i ).transition().attr("visibility","hidden");
			clicked_array[i] =1;

			d3.select(".bar_table_" + i).attr("width",function() { return xScale_table(d.points)-xScale_table(0) + xScale_table(d.losses*3) - xScale_table(0); });
		}
		else { 
			d3.select(".wins_" + i).transition().duration(350).delay(100).attr("width",function() {return 0;});
			d3.select(".wins_text_" + i ).transition().delay(350).attr("visibility","hidden");

			d3.select(".draws_" + i ).transition().duration(250).delay(100).attr("width",function() {return 0;});
			d3.select(".draws_text_" + i ).transition().delay(300).attr("visibility","hidden");			

			d3.select(".losses_" + i ).transition().duration(250).delay(0).attr("width",function() {return 0;});
			d3.select(".losses_text_" + i ).transition().delay(250).attr("visibility","hidden");	

			d3.select(".points_" + i ).transition().duration(250).delay(400).attr("width",xScale_table(d.points) - xScale_table(0));
			d3.selectAll(".points_text_table_" + i ).transition().delay(600).attr("visibility","visible");		

			d3.select(".arrow_table_" + i ).transition().delay(250).attr("visibility","hidden");	
			clicked_array[i] =0;

			d3.select(".bar_table_" + i).attr("width",function() {return xScale_table(d.points)-xScale_table(0);});
		}
	})
	//Set mouse enter. 
	//Removes points bar and transitions to win,draw,loss breakdown. 
	.on("mouseenter",function(d,i) { 
		if (clicked_array[i] ==0) { 
			d3.select(".points_" + i ).transition().attr("width",function() {return 0;});
			d3.select(".wins_" + i  ).transition().duration(250).delay(250).attr("width",function() {return xScale_table(d.wins*3) - xScale_table(0);});
			d3.select(".draws_" + i ).transition().duration(250).delay(300).attr("width",function() {return xScale_table(d.draws) - xScale_table(0);});
			d3.select(".losses_" + i).transition().duration(250).delay(350).attr("width",function() {return xScale_table(d.losses*3) - xScale_table(0);});
			d3.select(".wins_text_" + i).transition().delay(600).attr("visibility","visible");
			d3.select(".draws_text_" + i ).transition().delay(600).attr("visibility","visible");			
			d3.select(".losses_text_" + i ).transition().delay(600).attr("visibility","visible");
			d3.select(".arrow_table_" + i ).transition().delay(600).attr("visibility","visible");
			d3.selectAll(".points_text_table_" + i ).transition().attr("visibility","hidden");

			d3.select(".bar_table_" + i).attr("width",function() { return xScale_table(d.points)-xScale_table(0) + xScale_table(d.losses*3) - xScale_table(0); });
		}
	})
	//Set Mouseleave
	//Removes win,draw,loss breakdown and transitions to point overview.
	.on("mouseleave",function(d,i) { 
		if (clicked_array[i] ==0) { 
			d3.select(".wins_" + i).transition().duration(350).delay(100).attr("width",function() {return 0;});
			d3.select(".wins_text_" + i ).transition().delay(350).attr("visibility","hidden");

			d3.select(".draws_" + i ).transition().duration(250).delay(100).attr("width",function() {return 0;});
			d3.select(".draws_text_" + i ).transition().delay(300).attr("visibility","hidden");			

			d3.select(".losses_" + i ).transition().duration(250).delay(0).attr("width",function() {return 0;});
			d3.select(".losses_text_" + i ).transition().delay(250).attr("visibility","hidden");	

			d3.select(".points_" + i ).transition().duration(250).delay(400).attr("width",xScale_table(d.points) - xScale_table(0));
			d3.selectAll(".points_text_table_" + i ).transition().delay(600).attr("visibility","visible");		

			d3.select(".arrow_table_" + i ).transition().delay(250).attr("visibility","hidden");	

			d3.select(".bar_table_" + i).attr("width",function() {return xScale_table(d.points)-xScale_table(0);} );
		}	
	});
	//Add Win, Loss, Draw text
	svg_table.selectAll(".win_text").data(season)
		.attr("class",function(d,i) {return "wins_text_" + i + " win_text";})
		.attr("pointer-events","none")
		.attr("x",function(d) { return xScale_table(0) +3;})
		.attr("y",function(d) {return yScale_table(d.rank);})
		.attr("visibility","hidden")
		.attr("dy",".35em")
		.text(function(d) {
		return d.wins + " wins"; 
		});	

	svg_table.selectAll(".draw_text").data(season)
		.attr("class",function(d,i) {return "draws_text_" + i + " draw_text";})
		.attr("pointer-events","none")
		.attr("x",function(d) { return xScale_table(d.wins*3) + 3;})
		.attr("y",function(d) {return yScale_table(d.rank);})
		.attr("visibility","hidden")
		.attr("dy",".35em")
		.text(function(d) {
		return d.draws + " draws"; 
		});	

	svg_table.selectAll(".loss_text").data(season)
		.attr("class",function(d,i) {return "losses_text_" + i + " loss_text";})
		.attr("pointer-events","none")
		.attr("x",function(d) { return xScale_table(d.wins*3 +d.draws) +3 })
		.attr("y",function(d) {return yScale_table(d.rank);})
		.attr("visibility","hidden")
		.attr("dy",".35em")
		.text(function(d) {
		return d.losses + " losses"; 
		});	
}

</script>



<div class="container">
	<div class="in">
	<input type="checkbox" id="toggle">Check to See Cumulative Season Data<br>
	<div class="label">Select Metric to Compare:</div>
	<select id="metricsel">
		<option value="Total Shots">Total Shots</option>
		<option value="Corners">Corners</option>
		<option value="Crosses">Crosses</option>
		<option value="Goals">Goals</option>
		<option value="Penalties">Penalties</option>
		<option value="Saves">Saves</option>
		<option value="Goals Conceded">Goals Conceded</option>
	</select>

	<div class="label">Select Teams to Display Data:</div>
	<form>
		<input type="checkbox" id="t1" value="Leicester" checked>Leicester City<br>
		<input type="checkbox" id="t2" value="Spurs" checked>Tottenham Hotspur<br>
		<input type="checkbox" id="t3" value="Man City" checked>Manchester City<br>
		<input type="checkbox" id="t4" value="Arsenal" checked>Arsenal<br>
		<input type="checkbox" id="t5" value="Man Utd">Manchester United<br>
		<input type="checkbox" id="t6" value="West Ham">West Ham United<br>
		<input type="checkbox" id="t7" value="Southampton">Southampton<br>
		<input type="checkbox" id="t8" value="Liverpool">Liverpool<br>
		<input type="checkbox" id="t9" value="Stoke">Stoke City<br>
		<input type="checkbox" id="t10" value="Chelsea">Chelsea<br>
		<input type="checkbox" id="t11" value="Everton">Everton<br>
		<input type="checkbox" id="t12" value="Watford">Watford<br>
		<input type="checkbox" id="t13" value="Bournemouth">Bournemouth<br>
		<input type="checkbox" id="t14" value="West Brom">West Brom<br>
		<input type="checkbox" id="t15" value="Swansea">Swansea City<br>
		<input type="checkbox" id="t16" value="Crystal Palace">Crystal Palace<br>
		<input type="checkbox" id="t17" value="Norwich">Norwich City<br>
		<input type="checkbox" id="t18" value="Sunderland">Sunderland<br>
		<input type="checkbox" id="t19" value="Newcastle">Newcastle United<br>
		<input type="checkbox" id="t20" value="Aston Villa">Aston Villa<br>
	</form>
	</div>
	<div class="chart">
		<svg id="graph" width="1200" height="500"></svg>
	</div>
	<div class="legend" id="leg"></div>
</div>
<script>

var data,test;
d3.csv("gamestats.csv", function (error, rows) {
		if (error) {console.log(error);}
		data = processData(rows);
		genGraph(data);
});

//Compile team stats into an object array
function processData (rows)
{
	var teamdata = [];
	//Parse csv file
	for(var i = 0; i <rows.length; i++)
	{
		var away = rows[i].away_team;
		var home = rows[i].home_team;
		
		//Collect relevant data
		var hs = parseInt(rows[i].total_shots_home_team), as = parseInt(rows[i].total_shots_away_team);
		var hcn = parseInt(rows[i].corners_home_team), acn = parseInt(rows[i].corners_away_team);
		var hcr = parseInt(rows[i].crosses_home_team), acr = parseInt(rows[i].crosses_away_team);
		var hg = parseInt(rows[i].home_goals), ag = parseInt(rows[i].away_goals);
		var hp = parseInt(rows[i].penalties_home_team), ap = parseInt(rows[i].penalties_away_team);
		var hsv = parseInt(rows[i].saves_home_team), asv = parseInt(rows[i].saves_away_team);
		
		//Get game details
		var date = rows[i].date;
		var venue = rows[i].venue;
		
		var a = teamdata.findIndex(function (d){return d.team == away});
		var h = teamdata.findIndex(function (d){return d.team == home});
		//Add home/away team if not encountered yet, then append data
		if (a == -1)
		{
			var stats = {team:away, shots:[as],corner:[acn],cross:[acr],
			goals:[ag],pens:[ap],saves:[asv], home:[home], away:[away],date:[date],
			venue:[venue], goalc:[hg]};
			teamdata.push(stats);
		}
		else
		{
			teamdata[a].shots.push(as);
			teamdata[a].corner.push(acn);
			teamdata[a].cross.push(acr);
			teamdata[a].goals.push(ag);
			teamdata[a].pens.push(ap);	
			teamdata[a].saves.push(asv);
			teamdata[a].home.push(home);
			teamdata[a].away.push(away);
			teamdata[a].date.push(date);
			teamdata[a].venue.push(venue);
			teamdata[a].goalc.push(hg);
		}
		
		if (h == -1)
		{
			var stats = {team:home, shots:[hs],corner:[hcn],cross:[hcr],
			goals:[hg],pens:[hp],saves:[hsv], home:[home], away:[away], date:[date],
			venue:[venue], goalc:[ag]};
			teamdata.push(stats);
		}
		else
		{
			teamdata[h].shots.push(hs);
			teamdata[h].corner.push(hcn);
			teamdata[h].cross.push(hcr);
			teamdata[h].goals.push(hg);
			teamdata[h].pens.push(hp);
			teamdata[h].saves.push(hsv);
			teamdata[h].home.push(home);
			teamdata[h].away.push(away);
			teamdata[h].date.push(date);
			teamdata[h].venue.push(venue);		
			teamdata[h].goalc.push(ag);
		}	
	}
	return teamdata;
}

//Generate Graph
function genGraph (teamdata)
{
	var svg = d3.select("#graph");
	var width = svg.attr("width");
	var height = svg.attr("height");
	var padding = 60;
	
	//Clear svg
	svg.selectAll("*").remove();
	
	svg.append("rect").attr("height",height-padding*2).attr("width",width)
	.attr("x",padding).attr("y",padding).style("fill", "black").style("opacity",.1);
	
	//See which teams are selected for comparison
	var teams = [];
	for (var i=0; i < 20; i++)
	{
		if (document.getElementById("t"+(i+1)).checked)
			teams.push(document.getElementById("t"+(i+1)).value);
	}
	
	//Get relevant data for each selected team
	var teamstats = [];
	var max = 0;
	switch (document.getElementById("metricsel").value)
	{
		case "Total Shots":
			//Iterate through team data and collect data for teamstats
			//that are selected
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].shots.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].shots.slice()
					,games:gamedets});
				}
					
			}
			break;
		case "Corners":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].corner.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].corner.slice()
					,games:gamedets});
				}
			}
			break;
		case "Crosses":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].cross.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].cross.slice()
					,games:gamedets});
				}
			}
			break;
		case "Goals":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].goals.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].goals.slice()
					,games:gamedets});
				}
			}
			break;
		case "Penalties":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].pens.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].pens.slice()
					,games:gamedets});
				}
			}
			break;
		case "Saves":
			for (var i = 0; i <teamdata.length;i++)
				{
					if (teams.indexOf(teamdata[i].team)!= -1)
					{
						var gamedets = [];
						for (var t=0;t<teamdata[i].saves.length;t++)
						{
							gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
						}
						teamstats.push({team:teamdata[i].team,data:teamdata[i].saves.slice()
						,games:gamedets});
					}
				}
				break;
		case "Goals Conceded":
			for (var i = 0; i <teamdata.length;i++)
			{
				if (teams.indexOf(teamdata[i].team)!= -1)
				{
					var gamedets = [];
					for (var t=0;t<teamdata[i].goalc.length;t++)
					{
						gamedets.push({home:teamdata[i].home[t],away:teamdata[i].away[t],
						dat:teamdata[i].date[t],ven:teamdata[i].venue[t]})
					}
					teamstats.push({team:teamdata[i].team,data:teamdata[i].goalc.slice()
					,games:gamedets});
				}
			}
			break;
	}
	test = teamstats;
	//Check to See if Data should be displayed cumulatively or not
	if (document.getElementById("toggle").checked)
	{
		teamstats.forEach(function (d){
			for (var i=1;i<d.data.length;i++)
			{
				d.data[i] += d.data[i-1];
			}
		})
	}
	test = teamstats;
	
	//Find data maximum for scaling
	var max = 0;
	teamstats.forEach(function (d){
	var tmp = Math.max.apply(Math,d.data);
	if (tmp>max) max=tmp;});
	
	//Set Linear Scaling
	var xScale = d3.scale.linear().domain([0, 32])
	.range([padding, width]);
	var yScale = d3.scale.linear().domain([0,max])
	.range([height-padding, padding]);

	//Generate Axes
	var xAxis = d3.svg.axis().scale(xScale).orient("bottom");
	var yAxis = d3.svg.axis().scale(yScale).orient("left").tickFormat(d3.format("d"));
	svg.append("g").attr("class", "axis").attr("transform","translate(0,"+yScale(0)+")")
	.call(xAxis);
	svg.append("g").attr("class", "axis").attr("transform","translate(60,0)")
	.call(yAxis);

				
	//Axis Labels and Chart Title
	if (document.getElementById("toggle").checked)
	{	svg.append("text").attr("x",width/2 + 30).attr("y",20)
		.style("font-weight","bold").style("font-size",20)
		.text("Cumulative " + d3.select("#metricsel").node().value + " over the Season");
	
		svg.append("text").attr("x",width/2 + 30).attr("y",40)
		.style("font-weight","bold").style("font-size",14)
		.text("(Hover over points to see game details)");
	}
	else
	{	svg.append("text").attr("x",width/2 + 30).attr("y",20)
		.style("font-weight","bold").style("font-size",20)
		.text(d3.select("#metricsel").node().value + " per Game");
		
		svg.append("text").attr("x",width/2 + 30).attr("y",40)
		.style("font-weight","bold").style("font-size",14)
		.text("(Hover over points to see game details)");
	}
	svg.append("text").attr("x",padding).attr("y",250)
	.attr("transform", "translate (-240,300) rotate(-90)")
	.style("font-weight","bold").text(d3.select("#metricsel").node().value); ;
	svg.append("text").attr("y",yScale(0)+32).attr("x",width-20)
	.style("font-weight", "bold").text("Week");

	//Plot Points
	var color = d3.scale.category20();
	for (var t = 0; t < teamstats.length; t++)
	{
		for (var i=0; i < teamstats[t].data.length; i++)
		{
			svg.append("circle").attr("id",teamstats[t].team)
			.attr("cx", xScale(i)).attr("cy", yScale(teamstats[t].data[i]))
			.attr("r", 6).style("fill", color(t));
		}
		
		//Display game details when hovering
			var sel = svg.selectAll("circle[id='"+teamstats[t].team+"']");
			sel.data(teamstats[t].games).enter();
			sel.on("mouseover",function(){
				var curr = d3.select(this);
				var circposx = parseInt(curr.attr("cx")),circposy=parseInt(curr.attr("cy"));
				curr.style("stroke","black").attr("stroke-width",2);
				
				if (circposx >= xScale(29))
					circposx -= 70;
				else if (circposx == xScale(0))
					circposx += 20;
				svg.append("rect").attr("class","popup").attr("x",circposx-70)
				.attr("y",circposy-60);
			
				var inf = curr.data(); 
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-50).text("Home Team: " + inf[0].home);
				
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-40).text("Away Team: " + inf[0].away);
				
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-30).text("Date: " + inf[0].dat);
				
				svg.append("text").attr("class","popup").attr("x",circposx+12)
				.attr("y",circposy-20).text("Venue: " + inf[0].ven);
				
			})
			.on("mouseout",function(){d3.select(this).style("stroke","none");
			d3.selectAll("rect.popup").remove();
			d3.selectAll("text.popup").remove();});
		
	}


	//Plot Paths
	var week;
	var plotline = d3.svg.line()
	.x(function (d){week++; return xScale(week)})
	.y(function (d) {return yScale(d)});
	
	for (var t=0; t < teamstats.length; t++)
	{
		week = -1;
		svg.append("path").attr("d", plotline(teamstats[t].data))
		.attr("class","plot").attr("stroke", color(t));
	}
	
	
	//Generate legend
	d3.select("#leg").select("svg").remove();
	var legend = d3.select("#leg").append("svg").attr("width", 110)
	.attr("height", teams.length*20);
	legend.append("rect").attr("x", 0).attr("y",0)
	.attr("width", 100).attr("height", teams.length*17).style("stroke", "black")
	.style("fill","none");
	var space = 15;
	for (var t=0;t < teamstats.length; t++)
	{
		legend.append("rect").attr("x", 5).attr("y", t*space + 5)
		.attr("width", 10).attr("height",10).style("fill",color(t));
		
		legend.append("text").attr("x",52).attr("y", t*space+10)
		.style("font-size", 10).text(teamstats[t].team);
	}
	
}

//Update Graph when a new metric/team is selected
d3.selectAll("#metricsel").on("change", function(){genGraph(data)});
d3.selectAll("input").on("change", function(){genGraph(data)});

</script>



</body>
</html>	